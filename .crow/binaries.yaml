when:
  - event: tag
  - event: deployment

labels:
  type: autoscale

steps:
  build:
    image: reg.ricochet.rs/docker.io/library/rust:1.90-slim
    environment:
      GITHUB_TOKEN:
        from_secret: ricochet_bot_token
    commands:
      - apt-get update && apt-get install -y just pkg-config musl-tools libssl-dev curl wget nodejs build-essential cmake ca-certificates musl-tools musl-dev gcc-aarch64-linux-gnu gcc-riscv64-linux-gnu gcc-mingw-w64 clang lld llvm tree git
      # git auth
      - git config --global url."https://$GITHUB_TOKEN@github.com/".insteadOf "https://github.com/"
      # build sequentially to avoid file conflicts
      - just build-static linux-x86_64
      - just build-static linux-aarch64
      - just build-static windows-x86_64
      - tree target/binaries/
      - |
        # Determine version string
        if [ -n "${CI_COMMIT_TAG:-}" ]; then
          VERSION="${CI_COMMIT_TAG#v}"
        else
          # Use commit SHA if available, otherwise use date only
          if [ -n "${CI_COMMIT_SHA:-}" ]; then
            COMMIT_SHORT=$(echo "${CI_COMMIT_SHA}" | cut -c1-8)
            VERSION="$(date +%Y%m%d).$COMMIT_SHORT"
          else
            VERSION="$(date +%Y%m%d)"
          fi
        fi

        outdir="target/binaries/v$VERSION"
        mkdir -p "$outdir"

        # Move, rename, and compress binary files with version
        for file in target/binaries/ricochet-*; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            arch=$(echo "$filename" | sed 's/^ricochet-//')

            new_name="ricochet-$VERSION-$arch"
            mv "$file" "$outdir/$new_name"
            echo -e "Moved $filename -> $new_name"

            # Compress this binary immediately
            (cd "$outdir" && tar -czvf "$new_name.tar.gz" "$new_name" --remove-files)
            echo -e "Compressed $new_name.tar.gz"
          fi
        done

        echo -e "All binaries processed in $outdir/"
        ls -la "$outdir/"

  'Upload to S3':
    image: reg.ricochet.rs/docker.io/woodpeckerci/plugin-s3:1.5.2
    depends_on:
      - build
    settings:
      bucket: ricochet-cli
      region: hel1
      endpoint: https://hel1.your-objectstorage.com
      access_key:
        from_secret: s3_access_key
      secret_key:
        from_secret: s3_secret_key
      source: target/binaries/**/*
      strip_prefix: target/binaries/
      target: /

  changelog:
    image: reg.devxy.io/docker.io/thegeeklab/git-sv:2.0.5
    depends_on:
      - build
    commands:
      - apk add --no-cache -q sed
      - git sv current-version
      - git sv release-notes -t ${CI_COMMIT_TAG} -o CHANGELOG.md
      - sed -i '1,2d' CHANGELOG.md # remove version
      - cat CHANGELOG.md
    when:
      event: tag

  'Create release':
    image: reg.devxy.io/docker.io/woodpeckerci/plugin-release:0.2.6
    depends_on:
      - changelog
    settings:
      note: CHANGELOG.md
      api_key:
        from_secret: ricochet_issue_token
      files:
        - target/binaries/**/*.tar.gz
      title: ${CI_COMMIT_TAG}
    when:
      event: tag

  'Clone homebrew-tap':
    image: alpine:3.22
    depends_on:
      - changelog
    commands:
      - apk add --no-cache -q git
      - git clone https://github.com/ricochet-rs/homebrew-tap.git
    when:
      event: tag

  'Push changes to homebrew-tap':
    image: reg.ricochet.rs/docker.io/appleboy/drone-git-push:1.1.1
    depends_on:
      - 'Push changes to homebrew-tap'
    settings:
      path: homebrew-tap
      remote: git@github.com:ricochet-rs/homebrew-tap.git
      branch: main
      tag: ${CI_COMMIT_TAG}
      followtags: true
      ssh_key:
        from_secret: ricochet-bot-ssh-key
      author_name: ricochet-bot
      author_email: droid@ricochet.rs
    when:
      event: tag
