when:
  - event: pull_request
    branch: ${CI_REPO_DEFAULT_BRANCH}
  - event: push
    branch:
      - ${CI_REPO_DEFAULT_BRANCH}

labels:
  type: static

steps:
  cache:
    image: codeberg.org/crow-plugins/sccache:0.1.0
    settings:
      s3-endpoint: https://hel1.your-objectstorage.com
      s3-bucket: ricochet-sccache
      s3-region: hel1
      s3-key-prefix: ${CI_REPO_NAME}
      s3-access-key:
        from_secret: s3_access_key
      s3-secret-key:
        from_secret: s3_secret_key

  test:
    image: reg.devxy.io/docker.io/library/rust:1.89
    environment:
      SQLX_OFFLINE: true
      GITHUB_TOKEN:
        from_secret: ricochet_bot_token
    commands:
      - apt update && apt-get install -y cmake
      - export PATH=".sccache-cache:$PATH"
      - . ./.sccache
      # git auth
      - git config --global url."https://$GITHUB_TOKEN@github.com/".insteadOf "https://github.com/"
      # test
      - cargo test -q --all-features --workspace
